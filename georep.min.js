var georep={constants:{designDocs:[{name:"queries",handlers:[{name:"_view",views:["allDocsByUser","allDocsByDate"]},{name:"_spatial",views:["allDocsByLoc"]}]}],nodeJsServer:{proto:"http",host:"pram.homepc.it",port:1337}},db:{configured:false,name:undefined,host:undefined,port:undefined,proto:undefined,isConfigured:function(){if(this.configured)return true;else{this.configured=this.name!=undefined&&this.host!=undefined&&this.port!=undefined&&this.proto!=undefined;return this.configured}},setDBName:function(e){if(arguments.length!=1){throw"setDBName() richiede un argomento: DBName (string)."}else if(!e||typeof e!="string"){throw"Impossibile settare il nome del database, parametro non valido."}else{georep.db.name=e;georep.db.isConfigured()}},setURLServer:function(e){if(arguments.length!=1){throw"setURLServer() richiede un argomento: URLServer (object)."}else if(typeof e!="object"){throw'Impossibile settare "URLServer", parametro non valido.'}else if(!e.proto||typeof e.proto!="string"||!e.host||typeof e.host!="string"||!e.port||typeof e.port!="number"||e.port<1||e.port>65535){throw'Impossibile settare "URLServer", uno o piu\' properties non valide.'}else{georep.db.proto=e.proto;georep.db.host=e.host;georep.db.port=e.port;georep.db.isConfigured()}},getDoc:function(e,t,n){if(arguments.length<2)throw"getDoc() richiede almeno 2 argomenti: docId (string), attachment (boolean).";else if(!e||typeof e!="string"||typeof t!="boolean")throw"Uno o piu' parametri non validi.";else{var r=t?"?attachments=true":"?attachments=false";$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/"+georep.db.name+"/"+e+r,headers:{Authorization:"Basic "+georep.user.base64,Accept:"application/json"},success:function(e){if(n)n(undefined,e)},error:function(e,t,r){if(n)n({jqXHR:e,textStatus:t,errorThrown:r},undefined)}})}},getDocsInBox:function(e,t,n){var r=georep.constants.designDocs[0].name+"/"+georep.constants.designDocs[0].handlers[1].name+"/"+georep.constants.designDocs[0].handlers[1].views[0];var i="?bbox="+e.lng+","+e.lat+","+t.lng+","+t.lat;if(arguments.length<2)throw"getDocsInBox() richiede due argomenti: bl_corner (object), tr_corner (object).";else if(typeof e!="object"||typeof t!="object")throw"Uno o piu' parametri non validi: devono essere 'object'.";else if(!e.lng||typeof e.lng!="number"||e.lng<-180||e.lng>180||!e.lat||typeof e.lat!="number"||e.lat<-90||e.lat>90)throw"Parametro non valido: bl_corner.";else if(!t.lng||typeof t.lng!="number"||t.lng<-180||t.lng>180||!t.lat||typeof t.lat!="number"||t.lat<-90||t.lat>90)throw"Parametro non valido: tr_corner.";else if(arguments.length>2&&(!n||typeof n!="function"))throw"Parametro opzionale non valido: callback.";else if(!georep.db.isConfigured())throw"Impossibile contattare il database: db non cofigurato";else if(!georep.user.isConfigured())throw"Impossibile inviare la richiesta al server da un utente non configurato.";else{$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/"+georep.db.name+"/_design/"+r+i,type:"GET",headers:{Accept:"application/json",Authorization:"Basic "+georep.user.base64},success:function(e){if(n)n(undefined,e)},error:function(e,t,r){if(n)n({jqXHR:e,textStatus:t,errorThrown:r},undefined)}})}},getLastDocs:function(e,t){var n=georep.constants.designDocs[0].name+"/"+georep.constants.designDocs[0].handlers[0].name+"/"+georep.constants.designDocs[0].handlers[0].views[1];var r="?limit="+e+"&descending=true";if(arguments.length<1)throw"getLastDocs() richiede almeno un argomento: nDocs (number).";else if(!e||typeof e!="number"||e<=0)throw"parametro non valido: nDocs deve essere un numero maggiore di 0.";else if(arguments.length>1&&typeof t!="function")throw"parametro opzionale non valido: callback deve essere una funzione.";else if(!georep.db.isConfigured())throw"Impossibile contattare il database: db non cofigurato";else if(!georep.user.isConfigured())throw"Impossibile inviare la richiesta al server da un utente non configurato.";else{$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/"+georep.db.name+"/_design/"+n+r,type:"GET",headers:{Accept:"application/json",Authorization:"Basic "+georep.user.base64},success:function(e){if(t)t(undefined,e)},error:function(e,n,r){if(t)t({jqXHR:e,textStatus:n,errorThrown:r},undefined)}})}},getUserDocs:function(e,t){var n=georep.constants.designDocs[0].name+"/"+georep.constants.designDocs[0].handlers[0].name+"/"+georep.constants.designDocs[0].handlers[0].views[0];var r='?key="'+e+'"';if(arguments.length<1)throw"getUserDocs() richiede almeno un argomento: userId (string).";else if(!e||typeof e!="string")throw"parametro non valido: userId deve essere una stringa non vuota.";else if(arguments.length>1&&typeof t!="function")throw"parametro opzionale non valido: callback deve essere una funzione.";else if(!georep.db.isConfigured())throw"Impossibile contattare il database: db non cofigurato";else if(!georep.user.isConfigured())throw"Impossibile inviare la richiesta al server da un utente non configurato.";else{$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/"+georep.db.name+"/_design/"+n+r,type:"GET",headers:{Accept:"application/json",Authorization:"Basic "+georep.user.base64},success:function(e){if(t)t(undefined,e)},error:function(e,n,r){if(t)t({jqXHR:e,textStatus:n,errorThrown:r},undefined)}})}},postDoc:function(e,t,n){if(arguments.length<2)throw"postDoc() richiede almeno 2 argomenti: doc (object), attach (boolean).";else if(typeof t!="boolean")throw'Parametro "attach" non valito.';else if(typeof e!="object"||!e.title||typeof e.title!="string"||!e.msg||typeof e.msg!="string"||t&&(!e.img||typeof e.img!="object"||!e.img.content_type||typeof e.img.content_type!="string"||!e.img.data||typeof e.img.data!="string")||!e.loc||typeof e.loc!="object"||!e.loc.latitude||typeof e.loc.latitude!="number"||e.loc.latitude>90||e.loc.latitude<-90||!e.loc.longitude||typeof e.loc.longitude!="number"||e.loc.longitude>180||e.loc.longitude<-180){throw'Parametro "doc" non valido.'}else{var r={};r.userId=georep.user._id;r.title=e.title;r.date=(new Date).getTime();r.msg=e.msg;r.loc=e.loc;if(t){r._attachments={img:e.img}}$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/"+georep.db.name,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(r),headers:{Authorization:"Basic "+georep.user.base64},success:function(e){if(n)n(undefined,e)},error:function(e,t,r){if(n)n({jqXHR:e,textStatus:t,errorThrown:r},undefined)}})}}},user:{_id:undefined,base64:undefined,configured:false,mail:undefined,name:undefined,nick:undefined,password:undefined,roles:[],type:"user",check:function(e){if(arguments.length!=1||typeof e!="function"){throw"checkUser() richiede un argomento: callback (function(err, data))."}else if(!this.isConfigured()){throw"Impossibile controllare se l'utente e' registrato: utente non configurato."}else if(!georep.db.isConfigured()){throw"Impossibole controllare se l'utente e' registrato: server non configurato."}else{$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port,type:"GET",headers:{Authorization:"Basic "+georep.user.base64},success:function(t){e(undefined,{isRegistered:true})},error:function(t,n,r){if(r=="Unauthorized"){e(undefined,{isRegistered:false})}else{e({err:"Impossibile capire se l'utente e' registrato",jqXHR:t,textStatus:n,errorThrown:r},undefined)}}})}},getRemote:function(e){if(arguments.length!=1){throw"getRemote() richiede un argomento: callback (function(err, data))."}else if(typeof e!="function"){throw"Parametro non valido: callback deve essere 'function'."}else{$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/_users/"+georep.user._id,tyep:"GET",headers:{Accept:"application/json",Authorization:"Basic "+georep.user.base64},dataType:"json",success:function(t){e(undefined,t)},error:function(t,n,r){e({jqXHR:t,textStatus:n,errorThrown:r},undefined)}})}},isConfigured:function(){if(this.configured)return true;else{this.configured=this._id!=undefined&&this.base64!=undefined&&this.mail!=undefined&&this.name!=undefined&&this.nick!=undefined&&this.password!=undefined&&this.roles!=undefined&&this.type!=undefined;return this.configured}},set:function(e){if(arguments.length!=1){throw"setUser() richiede un argomento: user (object)."}else if(typeof e!="object"){throw'Impossibile settare "user", parametro non valido.'}else if(!e.name||typeof e.name!="string"||!e.password||typeof e.password!="string"||!e.nick||typeof e.nick!="string"||!e.mail||typeof e.mail!="string"){throw'Impossibile settare "user", uno o piu\' properties non valide.'}else{georep.user._id="org.couchdb.user:"+e.name;georep.user.name=e.name;georep.user.password=e.password;georep.user.base64=btoa(e.name+":"+e.password);georep.user.nick=e.nick;georep.user.mail=e.mail;georep.user.type="user";georep.user.roles=[];this.isConfigured()}},signup:function(e){if(arguments.length==1&&typeof e!="function"){throw"Il parametro opzionale deve essere una funzione"}else{$.ajax({url:georep.constants.nodeJsServer.proto+"://"+georep.constants.nodeJsServer.host+":"+georep.constants.nodeJsServer.port+"/_users",type:"POST",data:JSON.stringify({_id:georep.user._id,name:georep.user.name,password:georep.user.password,nick:georep.user.nick,mail:georep.user.mail,type:georep.user.type,roles:georep.user.roles}),headers:{Authorization:"Basic "+georep.user.base64},success:function(t){if(e){e(undefined,t)}},error:function(t,n,r){if(e){e({jqXHR:t,textStatus:n,errorThrown:r},undefined)}}})}},update:function(e,t){if(arguments.length<1){throw"update() richiede un argomento: user (object)."}else if(typeof e!="object"){throw"Impossibile aggiornare l'utente, parametro non valido."}else if(!e.name||typeof e.name!="string"||!e.password||typeof e.password!="string"||!e.nick||typeof e.nick!="string"||!e.mail||typeof e.mail!="string"){throw'Impossibile settare "user", uno o piu\' properties non valide.'}else if(arguments.length>1&&typeof t!="function"){throw"Il parametro opzionale deve essere una funzione"}else if(!georep.user.isConfigured()){throw"Utente corrente non configurato."}else if(!georep.db.isConfigured()){throw"Impossibile contattare il database: server non configurato."}else{this.getRemote(function(n,r){if(!n){var i=r._rev;$.ajax({url:georep.db.proto+georep.db.host+":"+georep.db.port+"/_users/"+georep.user._id+"?rev="+i,type:"PUT",headers:{Authorization:"Basic "+georep.user.base64},dataType:"json",data:JSON.stringify({name:e.name,password:e.password,nick:e.nick,mail:e.mail,type:georep.user.type,roles:georep.user.roles}),success:function(n){georep.user.set(e);georep.user.isConfigured();if(t){t(undefined,n)}},error:function(e,n,r){if(t){t({jqXHR:e,textStatus:n,errorThrown:r},undefined)}}})}else{if(t){t(n,undefined)}}})}}}}
